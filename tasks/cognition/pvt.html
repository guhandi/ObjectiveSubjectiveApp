<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Psychomotor Vigilance Task (PVT)</title>
	<script src="https://unpkg.com/jspsych@8.2.2"></script>
	<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
	<link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
	<style>
		body { background: #fff; }
		#timer { position: fixed; top: 10px; right: 10px; font-size: 20px; }
		.pvt-dot { font-size: 72px; line-height: 1; }
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
	<script src="/tasks/common.js"></script>
</head>
<body>
	<div id="timer"></div>

	<script>
		window.addEventListener('load', async () => {
			await initializeSessionMetadata('pvt_1min_v1', 'task');
		});
	</script>
</body>
<script>
	const PRACTICE_TRIALS = 2;
	const TOTAL_TRIALS = 20;
	const STIMULUS_DURATION = 1500;
	const ISI_MIN = 2000;
	const ISI_MAX = 5000;
	const TASK_ID = 'pvt_1min_v1';
	const APP_TYPE = 'task';

	const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;

	const jsPsych = initJsPsych({
		on_finish: async function() {
			await finishSession();
			document.body.innerHTML = `
				<h2>Thanks for participating!</h2>
				<p>Your data has been saved.</p>
				<p><a href="/">Return to Dashboard</a></p>
			`;
		}
	});

	const instructions = {
		type: jsPsychHtmlKeyboardResponse,
		stimulus: `
			<h2>Psychomotor Vigilance Task</h2>
			<p>You will see a circle appear on the screen at random intervals. Press the spacebar as quickly as you can each time it appears.<br>
			Try not to anticipate the stimulus.<br>
			Reaction times will be measured.<br>
			The task consists of 20 trials.</p>
			<p>Press the SPACEBAR to begin.</p>
		`,
		choices: [' ']
	};

	function make_pvt_trials(n, block) {
		let trials = [];
		for (let i = 0; i < n; i++) {
			const isi = Math.floor(Math.random() * (ISI_MAX - ISI_MIN + 1)) + ISI_MIN;
			trials.push({
				type: jsPsychHtmlKeyboardResponse,
				stimulus: '<div style="font-size:48px;">+</div>',
				choices: "NO_KEYS",
				trial_duration: isi,
				data: { phase: 'fixation' }
			});
			trials.push({
				type: jsPsychHtmlKeyboardResponse,
				stimulus: '<div class="pvt-dot">‚óè</div>',
				choices: [' '],
				trial_duration: STIMULUS_DURATION,
				data: {
					phase: block,
					trial_index: i,
					stimulus_id: `circle_${i}`,
					rt_ms: null,
					correct: 0,
					ts_utc: null,
					tz: tz
				},
				on_start: function(trial) {
					trial.data.ts_utc = new Date().toISOString();
				},
				on_finish: function(data) {
					data.rt_ms = data.rt;
					data.correct = (data.rt !== null && data.rt <= STIMULUS_DURATION) ? 1 : 0;
					logEventGeneric({
						eventType: 'task_trial',
						itemId: 'pvt_trial',
						eventIndex: data.trial_index,
						payload: data
					});
				}
			});
		}
		return trials;
	}

	let timeline = [];
	timeline.push(instructions);
	make_pvt_trials(PRACTICE_TRIALS, 'practice').forEach(trial => timeline.push(trial));
	timeline.push({
		type: jsPsychHtmlKeyboardResponse,
		stimulus: '<p>Practice complete. Press SPACEBAR to start the main task.</p>',
		choices: [' ']
	});
	make_pvt_trials(TOTAL_TRIALS, 'main').forEach(trial => timeline.push(trial));
	jsPsych.run(timeline);
</script>
</html>
