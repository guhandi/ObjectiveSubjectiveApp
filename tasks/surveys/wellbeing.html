<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Well-being Survey</title>
    <script>
        async function logEvent(itemId, value) {
            const payload = { "item_id": itemId, "value": value };
            await fetch('/api/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subject_id: 'demo',
                    session_id: 'sess_demo',
                    app_id: 'wellbeing',
                    app_type: 'survey',
                    event_type: 'survey_item',
                    event_index: 0, // This should be updated dynamically
                    ts_utc: new Date().toISOString(),
                    tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    payload: payload
                })
            });
        }

        function handleSubmit() {
            const formData = new FormData(document.querySelector('form'));
            let event_index = 0;
            const summaryData = {};

            formData.forEach((value, key) => {
                logEvent(key, value, event_index);
                summaryData[key] = value;
                event_index++;
            });

            // Reverse-code the wst_confident item
            summaryData['wst_confident'] = 4 - summaryData['wst_confident'];

            fetch('/api/session_complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subject_id: 'demo',
                    session_id: 'sess_demo',
                    app_id: 'wellbeing',
                    app_type: 'survey',
                    started_ts_utc: new Date().toISOString(),
                    ended_ts_utc: new Date().toISOString(),
                    tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    summary: summaryData,
                    events_count: formData.size
                })
            });
            alert('Survey submitted!');
        }
    </script>
</head>
<body>
    <div id="metadataModal" class="modal">
        <div class="modal-content">
            <span id="closeModal" style="float:right;">&times;</span>
            <h2>Enter Metadata</h2>
            <form id="metadataForm">
                <label for="subject_id">Subject ID:</label>
                <input type="text" id="subject_id" name="subject_id" required><br><br>
                <label for="session_id">Session ID:</label>
                <input type="text" id="session_id" name="session_id" readonly><br><br>
                <label for="start_timestamp">Start Timestamp:</label>
                <input type="text" id="start_timestamp" name="start_timestamp" readonly><br><br>
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>

    <h1>Weekly Well-being Survey</h1>
    <form onsubmit="event.preventDefault(); handleSubmit();">
        <label for="wwb_cheerful">I felt cheerful and in good spirits</label>
        <input type="range" id="wwb_cheerful" name="wwb_cheerful" min="0" max="5" value="2">
        <br><br>

        <label for="wwb_calm">I felt calm and relaxed</label>
        <input type="range" id="wwb_calm" name="wwb_calm" min="0" max="5" value="2">
        <br><br>

        <label for="wwb_active">I felt active and vigorous</label>
        <input type="range" id="wwb_active" name="wwb_active" min="0" max="5" value="2">
        <br><br>

        <label for="wwb_fresh">I woke up feeling fresh and rested</label>
        <input type="range" id="wwb_fresh" name="wwb_fresh" min="0" max="5" value="2">
        <br><br>

        <label for="wwb_interested">Daily life was filled with things that interest me</label>
        <input type="range" id="wwb_interested" name="wwb_interested" min="0" max="5" value="2">
        <br><br>

        <label for="wst_unexpected">How often did unexpected things upset you?</label>
        <input type="range" id="wst_unexpected" name="wst_unexpected" min="0" max="4" value="2">
        <br><br>

        <label for="wst_control">How often did you feel unable to control important things?</label>
        <input type="range" id="wst_control" name="wst_control" min="0" max="4" value="2">
        <br><br>

        <label for="wst_confident">How often did you feel confident about handling problems?</label>
        <input type="range" id="wst_confident" name="wst_confident" min="0" max="4" value="2">
        <br><br>

        <label for="wst_overwhelmed">How often did difficulties pile up so high you couldnâ€™t overcome them?</label>
        <input type="range" id="wst_overwhelmed" name="wst_overwhelmed" min="0" max="4" value="2">
        <br><br>

        <button type="submit">Submit</button>
    </form>

    <script>
        // Open the modal
        window.onload = function() {
            document.getElementById('metadataModal').style.display = 'block';
            document.getElementById('session_id').value = uuid.v4();
            document.getElementById('start_timestamp').value = new Date().toISOString();
        };

        // Close the modal
        document.getElementById('closeModal').onclick = function() {
            document.getElementById('metadataModal').style.display = 'none';
        };

        // Submit metadata
        document.getElementById('metadataForm').onsubmit = function(event) {
            event.preventDefault();
            const subject_id = document.getElementById('subject_id').value;
            const session_id = document.getElementById('session_id').value;
            const start_timestamp = document.getElementById('start_timestamp').value;

            fetch('/start-survey', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ subject_id, session_id, start_timestamp })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                document.getElementById('metadataModal').style.display = 'none';
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        };
    </script>
</body>
</html>
