<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Core Survey</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="/tasks/common.js"></script>
    <script>
        async function handleSubmit() {
            const formData = new FormData(document.getElementById('surveyForm'));
            let event_index = 0;
            const summaryData = {};

            for (const [key, value] of formData.entries()) {
                await logEventGeneric({
                    eventType: 'survey_item',
                    itemId: key,
                    eventIndex: event_index,
                    payload: { value: value }
                });
                summaryData[key] = value;
                event_index++;
            }

            // Reverse-code the stress item
            if (summaryData['stress_1to5'] !== undefined) {
                summaryData['stress_1to5'] = 6 - parseInt(summaryData['stress_1to5']);
            }
            // Calculate the mean score
            const numeric = Object.values(summaryData).map(v => parseInt(v)).filter(v => !Number.isNaN(v));
            const meanScore = numeric.length ? (numeric.reduce((a, b) => a + b, 0) / numeric.length) : null;

            await finishSession();
            alert('Survey submitted!');
        }

        window.addEventListener('load', async () => {
            await initializeSessionMetadata('daily_core', 'survey');
        });
    </script>
</head>
<body>
    <h1>Daily Core Survey</h1>
    <form id="surveyForm" onsubmit="event.preventDefault(); handleSubmit();">
        <label for="happiness_1to5">How happy do you feel right now?</label>
        <input type="range" id="happiness_1to5" name="happiness_1to5" min="1" max="5" value="3">
        <br>

        <label for="energy_1to5">How energized do you feel right now?</label>
        <input type="range" id="energy_1to5" name="energy_1to5" min="1" max="5" value="3">
        <br>

        <label for="stress_1to5">How stressed did you feel today?</label>
        <input type="range" id="stress_1to5" name="stress_1to5" min="1" max="5" value="3">
        <br>

        <label for="productive_1to5">How productive did you feel today?</label>
        <input type="range" id="productive_1to5" name="productive_1to5" min="1" max="5" value="3">
        <br>

        <label for="social_fulfillment_1to5">How fulfilled did your social connections feel today?</label>
        <input type="range" id="social_fulfillment_1to5" name="social_fulfillment_1to5" min="1" max="5" value="3">
        <br>

        <button type="submit">Submit</button>
    </form>
</body>
</html>
